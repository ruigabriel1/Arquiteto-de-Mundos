<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ sala.nome }} - Chat{% endblock %}</title>
    
    <!-- Tailwind CSS via CDN para desenvolvimento -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Estilos personalizados para o chat */
        .message-bubble {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .typing-indicator {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        .online-indicator {
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .offline-indicator {
            background: #6b7280;
        }
        
        .connection-status.connected {
            color: #10b981;
        }
        
        .connection-status.connecting {
            color: #f59e0b;
            animation: pulse 1s infinite;
        }
        
        .connection-status.disconnected {
            color: #ef4444;
        }
        
        /* Scroll personalizado */
        .chat-scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .chat-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .chat-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="bg-gray-100 h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <button onclick="history.back()" class="text-gray-600 hover:text-gray-900">
                        ‚Üê Voltar
                    </button>
                    <div>
                        <h1 class="text-xl font-semibold text-gray-900">{{ sala.nome }}</h1>
                        <p class="text-sm text-gray-600">{{ sala.campanha.nome }}</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Status de conex√£o -->
                    <div class="flex items-center space-x-2">
                        <span id="connectionStatus" class="connection-status disconnected">‚óè</span>
                        <span id="connectionText" class="text-sm text-gray-600">Desconectado</span>
                    </div>
                    
                    <!-- Bot√£o de participantes -->
                    <button 
                        id="toggleParticipants" 
                        class="flex items-center space-x-2 px-3 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
                    >
                        <span>üë•</span>
                        <span id="participantCount">{{ participantes|length }}</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Chat Area -->
    <div class="flex-1 flex min-h-0">
        <!-- Messages Area -->
        <div class="flex-1 flex flex-col">
            <!-- Error/Success Messages -->
            <div id="alertContainer" class="hidden"></div>
            
            <!-- Messages Container -->
            <div 
                id="messagesContainer" 
                class="flex-1 overflow-y-auto chat-scroll p-4 space-y-3"
            >
                <!-- Hist√≥rico de mensagens ser√° carregado aqui -->
            </div>
            
            <!-- Typing Indicator -->
            <div id="typingIndicator" class="px-4 py-2 text-sm text-gray-500 hidden">
                <span class="typing-indicator">üí¨ Algu√©m est√° digitando...</span>
            </div>
            
            <!-- Message Input -->
            <div class="border-t bg-white p-4">
                <div class="flex space-x-3">
                    <div class="flex-1">
                        <div class="relative">
                            <input
                                type="text"
                                id="messageInput"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Digite sua mensagem ou comando (/roll, /me, /whisper)..."
                                maxlength="2000"
                                disabled
                            />
                            <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-gray-400">
                                <span id="charCount">0</span>/2000
                            </div>
                        </div>
                        
                        <!-- Comandos r√°pidos -->
                        <div class="flex space-x-2 mt-2">
                            <button 
                                onclick="insertCommand('/roll 1d20')"
                                class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs hover:bg-green-200"
                            >
                                üé≤ D20
                            </button>
                            <button 
                                onclick="insertCommand('/roll advantage')"
                                class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs hover:bg-blue-200"
                            >
                                ‚¨ÜÔ∏è Vantagem
                            </button>
                            <button 
                                onclick="insertCommand('/me ')"
                                class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-xs hover:bg-purple-200"
                            >
                                üé≠ A√ß√£o
                            </button>
                        </div>
                    </div>
                    
                    <button
                        id="sendButton"
                        onclick="sendMessage()"
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        disabled
                    >
                        Enviar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Participants Sidebar -->
        <div id="participantsSidebar" class="w-80 bg-white border-l hidden">
            <div class="p-4 border-b">
                <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-gray-900">Participantes</h3>
                    <button onclick="toggleParticipants()" class="text-gray-500 hover:text-gray-700">
                        ‚úï
                    </button>
                </div>
            </div>
            
            <div id="participantsList" class="p-4 space-y-3">
                <!-- Lista de participantes ser√° carregada aqui -->
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o global
        const SALA_ID = {{ sala.id }};
        const WS_URL = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws/chat/sala/${SALA_ID}/`;
        
        // Estado do chat
        let chatSocket = null;
        let isConnected = false;
        let typingTimeout = null;
        let currentUser = null;
        
        // Elementos DOM
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');
        const participantCount = document.getElementById('participantCount');
        const typingIndicator = document.getElementById('typingIndicator');
        const charCount = document.getElementById('charCount');
        
        // Inicializar chat
        document.addEventListener('DOMContentLoaded', function() {
            loadChatHistory();
            connectWebSocket();
            setupEventListeners();
        });
        
        // Configurar event listeners
        function setupEventListeners() {
            // Enter para enviar mensagem
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Contador de caracteres
            messageInput.addEventListener('input', function() {
                const length = this.value.length;
                charCount.textContent = length;
                
                // Indicador de digita√ß√£o
                if (length > 0 && isConnected) {
                    sendTyping(true);
                    
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        sendTyping(false);
                    }, 3000);
                }
            });
            
            // Auto-scroll no chat
            messagesContainer.addEventListener('scroll', function() {
                // Carregar mais mensagens ao chegar no topo
                if (this.scrollTop === 0) {
                    loadMoreHistory();
                }
            });
        }
        
        // Conectar WebSocket
        function connectWebSocket() {
            if (chatSocket) {
                chatSocket.close();
            }
            
            updateConnectionStatus('connecting');
            
            try {
                chatSocket = new WebSocket(WS_URL);
                
                chatSocket.onopen = function(e) {
                    console.log('WebSocket conectado');
                    isConnected = true;
                    updateConnectionStatus('connected');
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                };
                
                chatSocket.onmessage = function(e) {
                    const data = JSON.parse(e.data);
                    handleWebSocketMessage(data);
                };
                
                chatSocket.onclose = function(e) {
                    console.log('WebSocket desconectado:', e.code);
                    isConnected = false;
                    updateConnectionStatus('disconnected');
                    messageInput.disabled = true;
                    sendButton.disabled = true;
                    
                    // Tentar reconectar ap√≥s 3 segundos
                    if (e.code !== 1000) {
                        setTimeout(connectWebSocket, 3000);
                    }
                };
                
                chatSocket.onerror = function(e) {
                    console.error('Erro WebSocket:', e);
                    showAlert('Erro de conex√£o', 'error');
                };
                
            } catch (error) {
                console.error('Erro ao conectar WebSocket:', error);
                updateConnectionStatus('disconnected');
            }
        }
        
        // Atualizar status de conex√£o
        function updateConnectionStatus(status) {
            connectionStatus.className = `connection-status ${status}`;
            
            switch (status) {
                case 'connected':
                    connectionText.textContent = 'Conectado';
                    break;
                case 'connecting':
                    connectionText.textContent = 'Conectando...';
                    break;
                case 'disconnected':
                    connectionText.textContent = 'Desconectado';
                    break;
            }
        }
        
        // Processar mensagens do WebSocket
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'chat_message':
                    if (data.mensagem) {
                        addMessageToChat(data.mensagem);
                        scrollToBottom();
                    }
                    break;
                    
                case 'user_status':
                    showAlert(`${data.usuario_nome} ${data.action} da sala`, 'info');
                    updateParticipantsList();
                    break;
                    
                case 'user_typing':
                    handleTypingIndicator(data.usuario_nome, data.is_typing);
                    break;
                    
                case 'system_notification':
                    showAlert(data.message, data.level || 'info');
                    break;
                    
                case 'error':
                    showAlert(data.message, 'error');
                    break;
                    
                case 'pong':
                    console.log('Pong recebido');
                    break;
            }
        }
        
        // Enviar mensagem
        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !isConnected) return;
            
            // Verificar se √© comando
            if (content.startsWith('/')) {
                sendCommand(content);
            } else {
                sendChatMessage(content);
            }
            
            messageInput.value = '';
            charCount.textContent = '0';
            sendTyping(false);
        }
        
        // Enviar mensagem de chat
        function sendChatMessage(message) {
            chatSocket.send(JSON.stringify({
                'action': 'send_message',
                'message': message
            }));
        }
        
        // Enviar comando
        function sendCommand(command) {
            chatSocket.send(JSON.stringify({
                'action': 'execute_command',
                'command': command
            }));
        }
        
        // Enviar indicador de digita√ß√£o
        function sendTyping(isTyping) {
            if (isConnected) {
                chatSocket.send(JSON.stringify({
                    'action': 'typing',
                    'is_typing': isTyping
                }));
            }
        }
        
        // Inserir comando r√°pido
        function insertCommand(command) {
            messageInput.value = command;
            messageInput.focus();
        }
        
        // Adicionar mensagem ao chat
        function addMessageToChat(mensagem) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-bubble';
            
            // Determinar classe CSS baseada no tipo
            let messageClass = 'bg-white border border-gray-200';
            let contentClass = '';
            
            switch (mensagem.tipo) {
                case 'WHISPER':
                    messageClass = 'bg-purple-50 border border-purple-200';
                    contentClass = 'text-purple-800';
                    break;
                case 'COMANDO_ACAO':
                    messageClass = 'bg-blue-50 border border-blue-200';
                    contentClass = 'text-blue-800 italic';
                    break;
                case 'COMANDO_ROLAGEM':
                    messageClass = 'bg-green-50 border border-green-200';
                    contentClass = 'text-green-800 font-semibold';
                    break;
                case 'SISTEMA':
                    messageClass = 'bg-yellow-50 border border-yellow-200';
                    contentClass = 'text-yellow-800 text-center';
                    break;
            }
            
            // Nome do usu√°rio
            let userName = 'Sistema';
            if (mensagem.usuario) {
                userName = mensagem.usuario.nome_completo || mensagem.usuario.username;
                if (mensagem.personagem) {
                    userName = `${mensagem.personagem.nome} (${userName})`;
                }
            }
            
            // Timestamp
            const timestamp = new Date(mensagem.timestamp).toLocaleTimeString('pt-BR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Conte√∫do da mensagem
            let content = mensagem.conteudo;
            
            // Processar rolagens
            if (mensagem.rolagem) {
                content += ` = <strong>${mensagem.rolagem.resultado}</strong>`;
                if (mensagem.rolagem.resultados_individuais) {
                    content += ` [${mensagem.rolagem.resultados_individuais.join(', ')}]`;
                }
            }
            
            // Processar comandos de a√ß√£o
            if (mensagem.tipo === 'COMANDO_ACAO' && content.startsWith('/me ')) {
                content = `${userName} ${content.substring(4)}`;
                userName = '';
            }
            
            messageDiv.innerHTML = `
                <div class="p-3 rounded-lg ${messageClass}">
                    <div class="flex items-center justify-between mb-1">
                        ${userName ? `<span class="font-semibold text-sm">${userName}</span>` : ''}
                        <span class="text-xs text-gray-500">${timestamp}</span>
                    </div>
                    <div class="${contentClass}">${content}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        }
        
        // Scroll para o final do chat
        function scrollToBottom() {
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
        
        // Indicador de digita√ß√£o
        function handleTypingIndicator(userName, isTyping) {
            if (isTyping) {
                typingIndicator.innerHTML = `<span class="typing-indicator">üí¨ ${userName} est√° digitando...</span>`;
                typingIndicator.classList.remove('hidden');
            } else {
                typingIndicator.classList.add('hidden');
            }
        }
        
        // Mostrar alerta
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            
            const colors = {
                'info': 'bg-blue-100 border-blue-400 text-blue-700',
                'success': 'bg-green-100 border-green-400 text-green-700',
                'warning': 'bg-yellow-100 border-yellow-400 text-yellow-700',
                'error': 'bg-red-100 border-red-400 text-red-700'
            };
            
            alertDiv.className = `border px-4 py-3 rounded ${colors[type] || colors.info}`;
            alertDiv.innerHTML = `
                ${message}
                <button onclick="this.parentElement.remove()" class="float-right font-bold ml-4">√ó</button>
            `;
            
            alertContainer.appendChild(alertDiv);
            alertContainer.classList.remove('hidden');
            
            // Auto-remover ap√≥s 5 segundos
            setTimeout(() => {
                alertDiv.remove();
                if (alertContainer.children.length === 0) {
                    alertContainer.classList.add('hidden');
                }
            }, 5000);
        }
        
        // Carregar hist√≥rico de mensagens
        async function loadChatHistory() {
            try {
                const response = await fetch(`/api/mensagens/api/mensagens/?sala_id=${SALA_ID}&page_size=50`);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    // Limpar container
                    messagesContainer.innerHTML = '';
                    
                    // Adicionar mensagens (API retorna mais recentes primeiro, ent√£o reverter)
                    data.results.reverse().forEach(mensagem => {
                        addMessageToChat(mensagem);
                    });
                    
                    scrollToBottom();
                }
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
            }
        }
        
        // Carregar mais hist√≥rico
        function loadMoreHistory() {
            // TODO: Implementar pagina√ß√£o
            console.log('Carregando mais mensagens...');
        }
        
        // Toggle da lista de participantes
        function toggleParticipants() {
            const sidebar = document.getElementById('participantsSidebar');
            sidebar.classList.toggle('hidden');
            updateParticipantsList();
        }
        
        // Atualizar lista de participantes
        async function updateParticipantsList() {
            try {
                const response = await fetch(`/api/mensagens/api/salas/${SALA_ID}/participantes/`);
                const participantes = await response.json();
                
                const participantsList = document.getElementById('participantsList');
                participantsList.innerHTML = '';
                
                participantes.forEach(participante => {
                    const participanteDiv = document.createElement('div');
                    participanteDiv.className = 'flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-50';
                    
                    const statusClass = participante.online ? 'online-indicator' : 'offline-indicator';
                    
                    participanteDiv.innerHTML = `
                        <div class="w-3 h-3 rounded-full ${statusClass}"></div>
                        <div class="flex-1">
                            <div class="font-medium text-sm">${participante.usuario_nome}</div>
                            <div class="text-xs text-gray-500">@${participante.username}</div>
                        </div>
                        ${participante.is_moderador ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Mod</span>' : ''}
                    `;
                    
                    participantsList.appendChild(participanteDiv);
                });
                
                // Atualizar contador
                const onlineCount = participantes.filter(p => p.online).length;
                participantCount.textContent = onlineCount;
                
            } catch (error) {
                console.error('Erro ao atualizar participantes:', error);
            }
        }
        
        // Ping peri√≥dico
        setInterval(() => {
            if (isConnected) {
                chatSocket.send(JSON.stringify({'action': 'ping'}));
            }
        }, 30000);
        
        // Limpar ao sair da p√°gina
        window.addEventListener('beforeunload', function() {
            if (chatSocket) {
                chatSocket.close(1000);
            }
        });
    </script>
</body>
</html>